set -e
until (echo > /dev/tcp/db/5432) >/dev/null 2>&1; do
  echo "Waiting for Postgres..."
  sleep 1
done

echo "Migrating..."
bundle exec rails db:migrate

echo "Seeding if needed…"
bundle exec rails runner 'if Category.count < 4 || Product.count < 10; Rake::Task["db:seed"].invoke; else puts "Seed skipped"; end'

echo "Starting Puma…"
exec bundle exec puma -C config/puma.rb
