<%# ============================
    Storefront Products (PLP + Homepage)
   ============================ %>

<% content_for :title, (@is_homepage ? "Prairie Naturals" : "Discover everyday essentials") %>

<%# -------------------- HOMEPAGE -------------------- %>
<% if @is_homepage %>
  <%= render "storefront/home/hero" %>
  <%= render "storefront/home/benefits" %>
  <%= render "storefront/home/quick_categories", categories: (@categories || Category.order(:name)) %>
  <%= render "storefront/home/featured_products" %>
  <%= render "storefront/home/promo" %>

<%# -------------------- PLP (LISTING) -------------------- %>
<% else %>
  <% total  = (@products.total_count rescue @products.size) %>
  <% offset = (@products.respond_to?(:offset_value) ? @products.offset_value : ((@products.current_page - 1) * @products.limit_value rescue 0)) %>
  <% first  = total.zero? ? 0 : offset + 1 %>
  <% last   = [offset + @products.size, total].min %>
  <% cat    = Category.find_by(id: params[:category_id]) %>

  <section class="container-fluid px-3 px-xl-4 py-3 plp-grid">
    <div class="row g-3">
      <!-- Sidebar (filters) -->
      <aside class="col-12 col-md-3 col-lg-2">
        <div class="card shadow-sm border-0 sticky-sidebar">
          <div class="card-body">
            <div class="d-flex align-items-baseline justify-content-between">
              <h2 class="h6 mb-0">Browse</h2>
              <%= link_to "Reset", storefront_products_path, class: "small link-quiet text-decoration-none" %>
            </div>

            <hr class="my-2">

            <%= form_with url: storefront_products_path, method: :get, local: true do %>
              <%# Preserve non-filter params (except page) %>
              <% request.query_parameters.except(:q, :category_id, :filter, :sort, :page).each do |k, v| %>
                <%= hidden_field_tag k, v %>
              <% end %>

              <div class="mb-3">
                <label class="form-label small fw-semibold">Search products…</label>
                <%= text_field_tag :q, params[:q].presence || params[:search],
                      class: "form-control form-control-sm",
                      placeholder: "e.g., Vitamin C" %>
              </div>

              <div class="mb-3">
                <label class="form-label small fw-semibold">Category</label>
                <%= select_tag :category_id,
                      options_for_select([["All Categories", ""]] + (@categories || Category.order(:name)).map { |c| [c.name, c.id] }, params[:category_id]),
                      class: "form-select form-select-sm" %>
              </div>

              <div class="mb-3">
                <label class="form-label small fw-semibold">Show</label>
                <%= select_tag :filter,
                      options_for_select([["All products", ""], ["On sale", "sale"], ["New", "new"], ["Recently updated", "recent"]],
                                         params[:filter].to_s),
                      class: "form-select form-select-sm" %>
              </div>

              <div class="mb-3">
                <label class="form-label small fw-semibold">Sort</label>
                <%= select_tag :sort,
                      options_for_select([["Name (A–Z)", ""], ["Price: Low → High", "price_asc"], ["Price: High → Low", "price_desc"], ["Rating", "rating"], ["Newest", "newest"]],
                                         params[:sort].to_s),
                      class: "form-select form-select-sm" %>
              </div>

              <div class="d-grid gap-2">
                <button class="btn btn-dark btn-sm" type="submit">Apply</button>
                <%= link_to "Clear", storefront_products_path, class: "btn btn-link btn-sm text-decoration-none" %>
              </div>
            <% end %>
          </div>
        </div>
      </aside>

      <!-- Main: header + toolbar + grid -->
      <main class="col-12 col-md-9 col-lg-10">
        <div class="d-flex flex-wrap align-items-end justify-content-between gap-2 mb-2">
          <div>
            <h1 class="h5 mb-1">
              <%= if cat&.name.present?
                    "Explore #{cat.name}"
                  elsif params[:q].present?
                    "Results for “#{h(params[:q])}”"
                  else
                    "Discover everyday essentials"
                  end %>
            </h1>
            <div class="text-muted small">
              Showing <%= first %>–<%= last %> of <%= total %> products
            </div>
          </div>

          <!-- Quick sort (keeps other filters) -->
          <div class="d-flex align-items-center gap-2">
            <%= form_with url: storefront_products_path, method: :get, local: true, class: "d-flex align-items-center gap-2" do %>
              <% request.query_parameters.except(:sort, :page).each { |k, v| %>
                <%= hidden_field_tag k, v %>
              <% } %>
              <label class="small text-muted">Sort</label>
              <%= select_tag :sort,
                    options_for_select([["Name (A–Z)", ""], ["Price: Low → High", "price_asc"], ["Price: High → Low", "price_desc"], ["Rating", "rating"], ["Newest", "newest"]],
                                       params[:sort].to_s),
                    class: "form-select form-select-sm", onchange: "this.form.submit()" %>
            <% end %>
          </div>
        </div>

        <!-- Active filter chips -->
        <div class="plp-chips d-flex flex-wrap gap-2 mb-2">
          <% if params[:q].present? %>
            <%= link_to storefront_products_path(request.query_parameters.except(:q, :page)), class: "chip chip-link", title: "Remove search" do %>
              Search: <%= h(params[:q]) %> ×
            <% end %>
          <% end %>
          <% if cat&.name.present? %>
            <%= link_to storefront_products_path(request.query_parameters.except(:category_id, :page)), class: "chip chip-link", title: "Remove category" do %>
              Category: <%= cat.name %> ×
            <% end %>
          <% end %>
          <% if params[:filter].present? %>
            <%= link_to storefront_products_path(request.query_parameters.except(:filter, :page)), class: "chip chip-link", title: "Remove filter" do %>
              Show: <%= params[:filter].humanize %> ×
            <% end %>
          <% end %>
          <% if params[:sort].present? %>
            <%= link_to storefront_products_path(request.query_parameters.except(:sort, :page)), class: "chip chip-link", title: "Remove sort" do %>
              Sort: <%= params[:sort].humanize %> ×
            <% end %>
          <% end %>
        </div>

        <%# ===== GRID ===== %>
        <% if @products.present? %>
          <div class="row row-cols-2 row-cols-sm-3 row-cols-md-4 row-cols-lg-5 row-cols-xxl-6 g-2">
            <% @products.each do |product| %>
              <% sale  = product.respond_to?(:sale_price) && product.sale_price.present? && product.sale_price.to_d < product.price.to_d rescue false %>
              <% stock = product.try(:stock) %>
              <% avg   =
                   if product.respond_to?(:reviews) && product.reviews.any?
                     product.reviews.average(:rating).to_f
                   else
                     (product.try(:average_rating) || product.try(:rating)).to_f
                   end %>

              <div class="col">
                <div class="card h-100 position-relative product-card">
                  <% if sale %>
                    <span class="badge bg-danger position-absolute m-2">Sale</span>
                  <% end %>

                  <div class="product-media" style="aspect-ratio: 4 / 5;">
                    <% if product.images.attached? %>
                      <%= link_to storefront_product_path(product) do %>
                        <%= image_tag product.images.first.variant(resize_to_limit: [1200, 1200]),
                                      class: "product-img", alt: product.name, loading: "lazy", decoding: "async" %>
                      <% end %>
                    <% elsif product.image_url.present? %>
                      <%= link_to storefront_product_path(product) do %>
                        <%= image_tag product.image_url, class: "product-img", alt: product.name, loading: "lazy", decoding: "async" %>
                      <% end %>
                    <% else %>
                      <%= link_to storefront_product_path(product), class: "product-img product-img--placeholder text-muted" do %>
                        No image
                      <% end %>
                    <% end %>
                  </div>

                  <div class="card-body d-flex flex-column p-2">
                    <h3 class="card-title small mb-1 clamp-2">
                      <%= link_to product.name, storefront_product_path(product), class: "pn-link text-decoration-none" %>
                    </h3>

                    <div class="d-flex align-items-center justify-content-between mb-1">
                      <div class="rating small">
                        <% r = avg.positive? ? avg : 0 %>
                        <span aria-label="<%= r %> out of 5 stars"><%= "★" * r.round %><%= "☆" * (5 - r.round) %></span>
                      </div>
                      <% if !stock.nil? %>
                        <% left = stock.to_i %>
                        <span class="small <%= left <= 5 ? 'text-danger' : 'text-muted' %>">
                          <%= left <= 5 ? "Only #{left} left" : "In stock: #{left}" %>
                        </span>
                      <% end %>
                    </div>

                    <div class="product-meta mb-2">
                      <% if sale %>
                        <div class="price">
                          <span class="fw-semibold text-danger"><%= number_to_currency(product.sale_price) %></span>
                          <span class="price-old small"><%= number_to_currency(product.price) %></span>
                        </div>
                      <% else %>
                        <div class="price">
                          <span class="fw-semibold"><%= number_to_currency(product.price || 0) %></span>
                        </div>
                      <% end %>
                    </div>

                    <div class="mt-auto">
                      <%= button_to "Add to Cart",
                            add_item_cart_path(product_id: product.id),
                            method: :post,
                            class: "btn btn-dark btn-sm w-100 btn-lift",
                            form: { "data-turbo" => "false" } %>
                    </div>
                  </div>
                </div>
              </div>
            <% end %>
          </div>

          <div class="mt-3 d-flex justify-content-center">
            <%= paginate @products if defined?(paginate) %>
          </div>
        <% else %>
          <div class="card border-0 shadow-sm">
            <div class="card-body p-5 text-center">
              <h2 class="h5 mb-2">No products found</h2>
              <p class="text-muted mb-4">Try adjusting filters, changing your search, or browsing all products.</p>
              <%= link_to "Browse all", storefront_products_path, class: "btn btn-dark btn-sm btn-lift" %>
            </div>
          </div>
        <% end %>
      </main>
    </div>
  </section>
<% end %>
