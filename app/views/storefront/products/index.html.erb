<%# app/views/storefront/products/index.html.erb %>
<% content_for :title, (@is_homepage ? "Prairie Naturals" : "Our Products") %>

<% if @is_homepage %>
  <%= render "storefront/home/hero" %>
  <%= render "storefront/home/benefits" %>
  <%= render "storefront/home/quick_categories" %>
  <%= render "storefront/home/featured_products" %>
  <%= render "storefront/home/promo" %>
<% else %>
  <%# ===== Your existing catalog UI (unchanged) ===== %>
  <div class="container-fluid pb-4">

    <% cat   = Category.find_by(id: params[:category_id]) %>
    <% total = (@products.total_count rescue @products.size) %>

    <% title_text =
         if cat&.name.present?
           "Explore #{cat.name}"
         elsif params[:q].present?
           "Results for “#{h(params[:q])}”"
         else
           "Discover everyday essentials"
         end %>

    <% subtitle_text =
         if cat&.name.present?
           "#{total} items curated in #{cat.name}"
         elsif params[:q].present?
           "#{total} matches — refine filters to narrow down"
         else
           "#{total} products — quality picks for daily care"
         end %>

    <section class="catalog-hero catalog-hero--text mb-3">
      <div class="catalog-hero__content container px-0 text-center">
        <h1 class="catalog-hero__title"><%= title_text %></h1>
        <p class="catalog-hero__subtitle"><%= subtitle_text %></p>

        <div class="catalog-hero__chips d-flex justify-content-center flex-wrap gap-2 mt-2">
          <%= link_to "On sale",
                storefront_products_path(params.permit(:q,:category_id,:sort).merge(filter: "sale", page: nil)),
                class: "chip chip-link" %>

          <%= link_to "New",
                storefront_products_path(params.permit(:q,:category_id,:sort).merge(filter: "new", page: nil)),
                class: "chip chip-link" %>

          <%= link_to "Get Newest",
                storefront_products_path(params.permit(:q,:category_id,:filter).merge(sort: "newest", page: nil)),
                class: "chip chip-link" %>
        </div>

        <div class="catalog-hero__chips d-flex justify-content-center flex-wrap gap-2">
          <% if params[:q].present? %>
            <span class="chip">Search: <%= h(params[:q]) %></span>
          <% end %>
          <% if cat&.name.present? %>
            <span class="chip">Category: <%= cat.name %></span>
          <% end %>
          <% if params[:filter].present? %>
            <span class="chip">Show: <%= params[:filter].humanize %></span>
          <% end %>
          <% if params[:sort].present? %>
            <span class="chip">Sort: <%= params[:sort].humanize %></span>
          <% end %>
        </div>
      </div>
    </section>

    <div class="row">
      <!-- Sidebar -->
      <aside class="col-12 col-md-3 col-lg-2 border-end">
        <div class="p-3 sticky-sidebar">
          <div class="sidebar-filters">
            <h5 class="mb-3">Browse</h5>

            <%= form_with url: storefront_products_path, method: :get, local: true, id: "product-filter-form" do %>
              <% request.query_parameters.except(:page, :q, :category_id, :filter, :sort).each do |k,v| %>
                <%= hidden_field_tag k, v %>
              <% end %>

              <div class="mb-3">
                <label class="form-label">Search</label>
                <%= text_field_tag :q, params[:q].presence || params[:search], class: "form-control", placeholder: "Search products…" %>
              </div>

              <div class="mb-3">
                <label class="form-label">Category</label>
                <%= select_tag :category_id,
                               options_for_select([["All Categories",""]] + @categories.map { |c| [c.name, c.id] }, params[:category_id]),
                               class: "form-select" %>
              </div>

              <div class="mb-3">
                <label class="form-label">Show</label>
                <%= select_tag :filter,
                               options_for_select([["All products",""],["On sale","sale"],["New","new"],["Recently updated","recent"]], params[:filter].to_s),
                               class: "form-select" %>
              </div>

              <div class="mb-3">
                <label class="form-label">Sort</label>
                <%= select_tag :sort,
                               options_for_select([["Name (A–Z)",""],["Price: Low → High","price_asc"],["Price: High → Low","price_desc"],["Rating","rating"],["Newest","newest"]], params[:sort].to_s),
                               class: "form-select" %>
              </div>

              <button class="btn btn-dark w-100" type="submit">Apply</button>
              <%= link_to "Clear", storefront_products_path, class: "btn btn-link w-100 mt-1" %>
            <% end %>
          </div>
        </div>
      </aside>

      <!-- Main content -->
      <main class="col-12 col-md-9 col-lg-10">
        <div class="px-3 px-md-4">
          <!-- Header -->
          <section class="catalog-intro py-2 mb-2">
            <% cat_name = Category.find_by(id: params[:category_id])&.name %>
            <h1 class="h4 fw-semibold mb-1"><%= cat_name.present? ? "Fresh picks for #{cat_name}" : "Fresh picks" %></h1>
            <p class="text-muted small mb-0">
              <%= (@products.total_count rescue @products.size) %> items
              <% if params[:q].present? %> · results for “<%= h(params[:q]) %>”<% end %>
            </p>
          </section>

          <% if @products.present? %>
            <div class="row row-cols-2 row-cols-sm-3 row-cols-md-4 row-cols-lg-5 row-cols-xl-6 g-2 product-grid">
              <% @products.each do |product| %>
                <% sale  = product.respond_to?(:sale_price) && product.sale_price.present? && product.sale_price.to_d < product.price.to_d rescue false %>
                <% stock = product.try(:stock) %>
                <% avg   =
                     if product.respond_to?(:reviews) && product.reviews.any?
                       product.reviews.average(:rating).to_f
                     else
                       (product.try(:average_rating) || product.try(:rating)).to_f
                     end %>

                <div class="col">
                  <div class="card h-100 position-relative product-card product-card--xxs">
                    <% if sale %>
                      <span class="badge bg-danger position-absolute m-1">Sale</span>
                    <% end %>

                    <div class="product-media">
                      <% if product.images.attached? %>
                        <%= image_tag product.images.first.variant(resize_to_limit: [1200, 1200]),
                                      class: "product-img", alt: product.name, loading: "lazy" %>
                      <% elsif product.image_url.present? %>
                        <%= image_tag product.image_url, class: "product-img", alt: product.name, loading: "lazy" %>
                      <% else %>
                        <div class="product-img product-img--placeholder">No image</div>
                      <% end %>
                    </div>

                    <div class="card-body d-flex flex-column">
                      <h6 class="card-title mb-1">
                        <%= link_to product.name, storefront_product_path(product), class: "link-plain" %>
                      </h6>

                      <div class="rating mb-1">
                        <% r = avg.positive? ? avg : 0 %>
                        <span class="stars"><%= "★" * r.round %><%= "☆" * (5 - r.round) %></span>
                        <% if r.positive? %><span class="small text-muted ms-1"><%= number_with_precision(r, precision: 1) %></span><% end %>
                      </div>

                      <div class="product-meta">
                        <% if sale %>
                          <div class="price">
                            <span class="price-current text-danger"><%= number_to_currency(product.sale_price) %></span>
                            <span class="price-old"><%= number_to_currency(product.price) %></span>
                          </div>
                        <% else %>
                          <div class="price"><span class="price-current"><%= number_to_currency(product.price || 0) %></span></div>
                        <% end %>

                        <% if !stock.nil? %>
                          <% left = stock.to_i %>
                          <div class="small <%= left <= 5 ? 'text-danger' : 'text-muted' %> stock-left">
                            <%= left <= 5 ? "Only #{left} left" : "In stock: #{left}" %>
                          </div>
                        <% end %>
                      </div>
                    </div>

                    <div class="card-footer bg-white border-0 pt-0">
                      <%= button_to "Add to Cart",
                            add_item_cart_path(product_id: product.id),
                            method: :post,
                            class: "btn btn-xs btn-dark w-100 rounded-3 btn-lift" %>
                    </div>
                  </div>
                </div>
              <% end %>
            </div>

            <div class="mt-3">
              <%= paginate @products if defined?(paginate) %>
            </div>
          <% else %>
            <div class="alert alert-info">No products found. Try changing the filters.</div>
          <% end %>
        </div>
      </main>
    </div>
  </div>
<% end %>
