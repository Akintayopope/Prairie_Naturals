<article class="card h-100 product-card">
  <!-- Product Image -->
  <div class="product-media">
    <%= link_to storefront_product_path(product), class: "d-block" do %>
      <% if product.images.attached? %>
        <%= image_tag product.images.first.variant(resize_to_limit: [1200, 1200]),
                      class: "product-img", alt: product.name,
                      loading: "lazy", decoding: "async" %>
      <% elsif product.image_url.present? %>
        <%= image_tag product.image_url,
                      class: "product-img", alt: product.name,
                      loading: "lazy", decoding: "async" %>
      <% else %>
        <span class="product-img product-img--placeholder text-muted">No image</span>
      <% end %>
    <% end %>
  </div>

  <!-- Card Body -->
  <div class="card-body d-flex flex-column p-2">
    <!-- Product Name -->
    <h3 class="card-title small mb-1 clamp-2">
      <%= link_to product.name, storefront_product_path(product),
                  class: "pn-link text-decoration-none" %>
    </h3>

    <!-- Rating + Stock -->
    <div class="d-flex align-items-start justify-content-between mb-2">
      <% r   = (product.respond_to?(:display_rating) ? product.display_rating : product.rating).to_f %>
      <% cnt = (product.respond_to?(:total_reviews) ? product.total_reviews : product.try(:reviews_count)).to_i %>

      <div class="pn-rating text-center flex-grow-1 me-2"
           aria-label="<%= r.round(1) %> out of 5 stars, <%= cnt %> <%= 'review'.pluralize(cnt) %>">
        <div class="pn-stars mb-1">
          <% full = r.floor; half = (r - full) >= 0.5 %>
          <% 5.times do |i| %>
            <% if i < full %>
              <span class="star star-full">★</span>
            <% elsif i == full && half %>
              <span class="star star-half">★</span>
            <% else %>
              <span class="star star-empty">★</span>
            <% end %>
          <% end %>
        </div>
        <div class="pn-rating-meta small">
          <span class="pn-rating-number fw-semibold"><%= number_with_precision(r, precision: 1) %></span>
          <span class="text-muted">• <%= number_with_delimiter(cnt) %> <%= 'review'.pluralize(cnt) %></span>
        </div>
      </div>

      <% if product.stock.present? %>
        <% left = product.stock.to_i %>
        <span class="badge <%= left <= 5 ? 'bg-danger' : 'bg-success' %>">
          <%= left <= 5 ? "Only #{left} left" : "In stock" %>
        </span>
      <% end %>
    </div>

    <!-- Price -->
    <div class="product-meta mb-2">
      <% if sale %>
        <div class="price">
          <span class="fw-semibold text-danger"><%= number_to_currency(product.sale_price) %></span>
          <span class="price-old small"><%= number_to_currency(product.price) %></span>
        </div>
      <% else %>
        <div class="price">
          <span class="fw-semibold"><%= number_to_currency(product.price || 0) %></span>
        </div>
      <% end %>
    </div>

    <!-- Add to Cart -->
    <div class="mt-auto">
      <%= button_to "Add to Cart",
            add_item_cart_path(product_id: product.id),
            method: :post,
            class: "btn-lift w-100",
            form: { "data-turbo" => "false" } %>
    </div>
  </div>
</article>
