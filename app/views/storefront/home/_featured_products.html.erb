<%# app/views/storefront/home/_featured_products.html.erb %>
<section class="container-xxl home-section">
  <header class="text-center mb-4">
    <h2 class="pn-section-title">Featured Products</h2>
    <p class="text-muted mb-0">A curated selection from our catalog â€” pure, purposeful, and loved by our community.</p>
  </header>

  <% products = (@featured_products || []) %>

  <% if products.any? %>
    <div class="row g-3 row-cols-1 row-cols-md-2 row-cols-lg-3">
      <% products.each do |product| %>
        <% sale = product.respond_to?(:sale_price) && product.sale_price.present? && product.sale_price.to_d < product.price.to_d rescue false %>
        <% category_name = product.try(:category)&.name %>

        <div class="col">
          <article class="pn-feature-card h-100" itemscope itemtype="https://schema.org/Product">
            <meta itemprop="name" content="<%= product.name %>">

            <div class="pn-feature-card__media">
              <%= link_to storefront_product_path(product), class: "d-block", aria: { label: product.name } do %>
                <% if product.images.attached? %>
                  <% img = product.images.first %>
                  <%= image_tag img.variant(resize_to_limit: [800, 800]),
                                alt: product.name, loading: "lazy", width: 800, height: 800 %>
                <% elsif product.image_url.present? %>
                  <%= image_tag product.image_url, alt: product.name, loading: "lazy", width: 800, height: 800 %>
                <% else %>
                  <div class="pn-card__img pn-card__img--ph">No image</div>
                <% end %>
              <% end %>
            </div>

            <div class="pn-feature-card__body">
              <% if category_name.present? %>
                <%= link_to category_name,
                            (product.category ? storefront_category_path(product.category) : storefront_products_path(category: category_name)),
                            class: "pn-badge is-link",
                            aria: { label: "More in #{category_name}" } %>
              <% end %>

              <h3 class="pn-feature-card__title clamp-2">
                <%= link_to product.name, storefront_product_path(product), class: "pn-link-plain" %>
              </h3>

              <div class="small mt-1 mb-3">
                <% if sale %>
                  <span class="text-danger fw-semibold" itemprop="offers" itemscope itemtype="https://schema.org/Offer">
                    <meta itemprop="priceCurrency" content="CAD">
                    <meta itemprop="price" content="<%= product.sale_price %>">
                    <link itemprop="availability" href="https://schema.org/InStock">
                    <%= number_to_currency(product.sale_price) %>
                  </span>
                  <span class="price-old"><%= number_to_currency(product.price) %></span>
                <% else %>
                  <span class="fw-semibold" itemprop="offers" itemscope itemtype="https://schema.org/Offer">
                    <meta itemprop="priceCurrency" content="CAD">
                    <meta itemprop="price" content="<%= product.price || 0 %>">
                    <link itemprop="availability" href="https://schema.org/InStock">
                    <%= number_to_currency(product.price || 0) %>
                  </span>
                <% end %>
              </div>

              <div class="d-grid">
                <%= link_to "Shop this product",
                            storefront_product_path(product),
                            class: "btn btn-lift" %>
              </div>
            </div>
          </article>
        </div>
      <% end %>
    </div>

    <div class="text-center mt-4">
      <%= link_to "View All Products", storefront_products_path, class: "btn btn-cta" %>
    </div>
  <% else %>
    <div class="card border-0 shadow-sm">
      <div class="card-body p-5 text-center">
        <h3 class="h5 mb-2">No featured products yet</h3>
        <p class="text-muted mb-3">Add some items to your featured set, or browse the full catalog.</p>
        <%= link_to "Browse all products", storefront_products_path, class: "btn btn-dark btn-sm btn-lift" %>
      </div>
    </div>
  <% end %>
</section>

