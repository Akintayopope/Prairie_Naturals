<h1>Order #<%= @order.id %></h1>

<p><strong>Status:</strong> <%= @order.status.to_s.titleize %></p>
<p><strong>Placed on:</strong> <%= @order.created_at.strftime("%B %d, %Y") %></p>

<%# Paid date + payment method (safe if paid_at is missing) %>
<% paid_on = @order.try(:paid_at) || (@order.status.to_s == "paid" ? @order.updated_at : nil) %>
<% if paid_on.present? %>
  <p>
    <strong>Paid on:</strong>
    <%= paid_on.in_time_zone.strftime("%B %d, %Y %l:%M %p") %><br>

    <% brand = @order.try(:payment_brand) || @order.try(:card_brand) %>
    <% last4 = @order.try(:payment_last4) || @order.try(:card_last4) %>
    <% pi    = @order.try(:payment_intent_id) || @order.try(:stripe_payment_intent_id) %>
    <% chg   = @order.try(:charge_id)        || @order.try(:stripe_charge_id) %>

    <% if brand.present? || last4.present? || pi.present? || chg.present? %>
      <strong>Payment:</strong>
      <%= (brand.present? ? brand.to_s.titleize : "Card") %>
      <% if last4.present? %> •••• <%= last4 %><% end %><br>
      <% if pi.present? %><small>PI: <%= pi %></small><br><% end %>
      <% if chg.present? %><small>Charge: <%= chg %></small><% end %>
    <% end %>
  </p>
<% end %>

<h3>Shipping</h3>
<p>
  <%= @order.shipping_name %><br>
  <% if @order.address %>
    <%= @order.address.full_address %>
  <% else %>
    <%= @order.shipping_address %>
    <% if @order.province.present? %>, <%= @order.province %><% end %>
  <% end %>
</p>

<h3>Items</h3>
<table style="width:100%;border-collapse:collapse;">
  <thead>
    <tr>
      <th style="text-align:left;border-bottom:1px solid #ddd;padding:6px 0;">Product</th>
      <th style="text-align:center;border-bottom:1px solid #ddd;">Qty</th>
      <th style="text-align:right;border-bottom:1px solid #ddd;">Unit</th>
      <th style="text-align:right;border-bottom:1px solid #ddd;">Line Total</th>
    </tr>
  </thead>
  <tbody>
    <% @order.order_items.each do |item| %>
      <tr>
        <td style="padding:6px 0;"><%= item.product&.name || "Product ##{item.product_id}" %></td>
        <td style="text-align:center;"><%= item.quantity %></td>
        <td style="text-align:right;"><%= number_to_currency(item.unit_price) %></td>
        <td style="text-align:right;"><%= number_to_currency(item.quantity * item.unit_price) %></td>
      </tr>
    <% end %>
  </tbody>
</table>

<div style="margin-top:12px;">
  <p><strong>Subtotal:</strong> <%= number_to_currency(@order.subtotal) %></p>
  <p><strong>Tax<%= @order.province.present? ? " (#{@order.province})" : "" %>:</strong> <%= number_to_currency(@order.tax) %></p>
  <p><strong>Total:</strong> <%= number_to_currency(@order.total) %></p>
</div>

<%# Show "Proceed to Payment" if order is still pending %>
<% if @order.status == "pending" %>
  <div style="margin-top:16px;">
    <%= button_to "Proceed to Payment",
                  checkout_path(order_id: @order.id),
                  method: :post,
                  class: "button",
                  form: { data: { turbo: true } } %>
  </div>
<% end %>

<div style="margin-top:12px;">
  <% if @order.respond_to?(:stripe_receipt_url) && @order.stripe_receipt_url.present? %>
    <p><%= link_to "View Stripe Receipt", @order.stripe_receipt_url, target: "_blank", rel: "noopener" %></p>
  <% end %>

  <%# Prawn PDF links (requires OrdersController#receipt) %>
  <% if defined?(receipt_order_path) %>
    <p style="margin:0 0 8px;">
      <%= link_to "Open Receipt (PDF)",      receipt_order_path(@order, format: :pdf),        class: "button button--secondary", target: "_blank", rel: "noopener" %>
      &nbsp;·&nbsp;
      <%= link_to "Download Receipt (PDF)",  receipt_order_path(@order, format: :pdf, dl: 1), class: "button", target: "_blank", rel: "noopener" %>
    </p>

    <div class="card" style="border:1px solid #e5e5e5;border-radius:6px;overflow:hidden;">
      <div class="card-header" style="background:#f8f9fa;padding:8px 12px;border-bottom:1px solid #e5e5e5;">Receipt Preview</div>
      <div class="card-body" style="height:640px;padding:0;">
        <object data="<%= receipt_order_path(@order, format: :pdf) %>"
                type="application/pdf" width="100%" height="100%">
          <p style="padding:12px;">
            Your browser can’t display the preview.
            <%= link_to "Download the receipt PDF",
                        receipt_order_path(@order, format: :pdf, dl: 1),
                        class: "btn btn-link p-0" %>
          </p>
        </object>
      </div>
    </div>
  <% end %>
</div>

<p style="margin-top:16px;">
  <%= link_to "Back to My Orders", orders_path, class: "button" %>
  <%= link_to "Back to Store", storefront_products_path, class: "button" %>
</p>
